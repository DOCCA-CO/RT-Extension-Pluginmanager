#!/usr/bin/perl

##use strict;
use lib "/opt/rt4/lib";
use lib "/opt/rt4/local/lib";

use RT;
use RT::Interface::CLI qw(CleanEnv GetCurrentUser);

use Data::Dumper;

#CleanEnv();
RT::LoadConfig();
RT::Init();

use RT::Search::FromSQL;
use XML::Simple;
use LWP::Simple;

use File::Slurp qw(write_file);
use File::Spec::Functions qw( catfile );
use File::Basename qw ( basename );
use POSIX qw(strftime);
use Time::Local;
## use Archive::Zip qw(:ERROR_CODES :CONSTANTS);
use Archive::Extract;

use RT::Queue;
use RT::Ticket;
use RT::Tickets;
use RT::CustomField;

# new

# resolved

sub ReloadTicketSet {
    my $current_user = shift;
    my @PMQueueTickets;
    my $queue = RT::Queue->new($current_user);
    $queue->Load("_Marketplace");

    my $tickets = RT::Tickets->new($current_user);
    my $foo = RT::Search::FromSQL->new(Argument => "Queue='_Marketplace' AND Status='new'", TicketsObj => $tickets);
    $foo->Prepare();
    while ( my $ticket = $tickets->Next() ) {
        # Do something with each ticket we've found
        my $QueueObj = $ticket->QueueObj;
        my $queue_cfs = $queue->TicketCustomFields;
        $queue_cfs->LimitToQueue($queue->Id);
        my %cf;
        while (my $queue_cf=$queue_cfs->Next()) {
            $cf{$queue_cf->Name} = $ticket->FirstCustomFieldValue($queue_cf->Name);
        }

        push @PMQueueTickets, {
            id=>$ticket->Id, 
            subject=>$ticket->Subject,
            _mp_PluginName => $cf{'_mp_PluginName'} || "",
            _mp_RestartDate => $cf{'_mp_RestartDate'} || "",
            _mp_LinkToDownload => $cf{'_mp_LinkToDownload'} || "",
        }
    }
    return @PMQueueTickets;
}

sub WriteMessageAndCloseTicket {
    my ($current_user, $ticketID, $ticketMsg) = @_;
    print "Processing ticket #$ticketID\t$ticketMsg\n";

    my $obj = RT::Ticket->new($current_user);
    if ($obj->Load($ticketID)) {
        $obj->Comment(Content => $ticketMsg);

    } else {
        print ":(\n";
    }
    my ($status, $msg) = $obj->SetStatus("resolved"); 
    return ($status, $msg);
}


sub getTimestamp {
    my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst)=localtime(time);
    my $timestamp = sprintf ( "%04d-%02d-%02d %02d:%02d",
                                   $year+1900,$mon+1,$mday,$hour,$min);
    return $timestamp;
}


sub DownloadZIP {
    my $url      = shift;
    (my $filename = $url) =~ s/^.*\///;

    my $rc = getstore($url, "/tmp/$filename");
    if (is_error($rc)) {
        return undef;
    }
    return "/tmp/$filename";
}

my $CurrentUser = $RT::SystemUser;
#GetCurrentUser();

print "Hello, ", $CurrentUser->RealName, " \n";

my @MPQueueTickets;
@MPQueueTickets = ReloadTicketSet($CurrentUser);

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime();
$year += 1900; 
$mon+=1;

foreach my $PluginTicket (@MPQueueTickets) {
    my ($_year,$_mon,$_mday,$_hour,$_min,$_sec) = split(/[\s-:]+/, $PluginTicket->{_mp_RestartDate});
    if (($year == $_year) and ($mon==$_mon) and ($mday==$_mday) and ($hour==$_hour)) {
        my $rc = DownloadZIP($PluginTicket->{_mp_LinkToDownload});
        if ( $rc ) {
            my $path = $RT::LocalPluginPath;
            my $conf = "$RT::EtcPath/RT_SiteConfig.d/$PluginTicket->{_mp_PluginName}.pm";
##        my $zip = Archive::Zip->new($rc);
##        $zip->extractTree('', $path);
            my $ae = Archive::Extract->new( archive => $rc );
### what if something went wrong?
            my $ok = $ae->extract(to => $path); ## or die $ae->error;
            if ( $ok ) {
                (my $c = $PluginTicket->{_mp_PluginName})=~s/-/::/ig;
                write_file($conf, "Plugin(\"$c\");\n");
                WriteMessageAndCloseTicket($CurrentUser, $PluginTicket->{id}, "Successfully installed plugin $PluginTicket->{_mp_PluginName}");
            } else {
                WriteMessageAndCloseTicket($CurrentUser, $PluginTicket->{id}, "Could not install plugin $PluginTicket->{_mp_PluginName}. $ae->error");
            }
##
#   Create ticket for PluginManager
##
            my $user = RT::User->new($current_user);
            $user->Load('root');

            my $ticketObj = RT::Ticket->new($user); # empty ticket object
            my %args = (
                Queue=>"_Pluginmanager",
                Subject => $PluginTicket->{_mp_PluginName},
                Requestor=>$user->Name,
                Owner=>$user->id,
                Priority=>10,
                InitialPriority=>0,
            );

            my ($val, $msg) = $ticketObj->Create(%args);
            if ($val) {
                $ticketObj->Comment(Content => $PluginTicket->{_mp_PluginName});
                my $cfObj = RT::CustomField->new($user);
                $cfObj->Load('_pm_PluginName');
                $ticketObj->AddCustomFieldValue(Field => $cfObj->Id, Value => $PluginTicket->{_mp_PluginName});
                $cfObj->Load('_pm_OnDate');
                $ticketObj->AddCustomFieldValue(Field => $cfObj->Id, Value => getTimestamp());
                $cfObj->Load('_pm_PluginStatus');
                $ticketObj->AddCustomFieldValue(Field => $cfObj->Id, Value => 1);
                print "$val \t $ticketObj->EffectiveId\n";
            }
        } else {
##
#   If something wrong
##
            WriteMessageAndCloseTicket($CurrentUser, $PluginTicket->{id}, "Could not install plugin $PluginTicket->{_mp_PluginName}");
        }
    } else {
        print "\tPlugin \'$PluginTicket->{_mp_PluginName}\' will be installed after $PluginTicket->{_mp_RestartDate}\n";
    }
}
1;
